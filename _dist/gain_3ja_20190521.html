<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>르 피에르</title>
    <style>
      html,
      body {
        padding: 0;
        margin: 0;
        height: 100%;
        overflow: hidden;
        background-color: rgb(238, 238, 238);
      }
      #control_container {
        position: absolute;
        height: 30px;
        right: 10px;
        bottom: 10px;
        z-index: 1;
      }
      #mute_control {
        width: 30px;
        height: 30px;
      }
    </style>
    <script>
      if (window.ReactNativeWebView) {
        window.postMessage = function(data) {
          window.ReactNativeWebView.postMessage(data);
        };
      }
    </script>
  </head>
  <body>
    <script src="https://player.vimeo.com/api/player.js"></script>
    <script>
      function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?#&]" + name + "(=([^&#]*)|&|#|$)"),
          results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return "";

        return decodeURIComponent(results[2].replace(/\+/g, " "));
      }
    </script>
    <div id="villa_home_tour" style="width:100%; height: 100%;">
      <div id="control_container">
        <img
          id="mute_control"
          src="./static/img/btn_villa_video_sound_off_15x15_nor.png"
          onclick="(function(e) { e.preventDefault(); e.stopPropagation(); toggleMute()})(event)"
        />
      </div>
    </div>
    <script>
      var video_url = getParameterByName("video_url");
      var platform = getParameterByName("platform");
      var os = getParameterByName("os");
      var width = getParameterByName("width");
      var height = getParameterByName("height");
      var buffering = false;
      var volume = 0;

      var options = {
        id: video_url,
        width: width,
        height: height,
        byline: 0,
        muted: 1,
        loop: 0,
        autoplay: 1,
        playsinline: 1
      };
      var player = new Vimeo.Player("villa_home_tour", options);
      player.setVolume(0);
      player.on("loaded", function() {
        var message = {
          event: "videoLoaded"
        };
        window.parent.postMessage(JSON.stringify(message), "*");
      });
      player.on("timeupdate", function(data) {
        if (buffering) return;
        var message = {
          event: "timeupdate",
          value: data
        };
        window.parent.postMessage(JSON.stringify(message), "*");
      });
      player.on("bufferstart", function() {
        buffering = true;
      });
      player.on("bufferend", function() {
        buffering = false;
      });
    </script>
    <script>
      if (os) {
        // 새 버전
        var usingDocument = os === "android";
        if (usingDocument) {
          document.addEventListener("message", receiveMessage, false);
        } else {
          window.addEventListener("message", receiveMessage, false);
        }
      } else {
        // 구 버전 호환용
        var fromApp = platform !== "www" && platform !== "m";
        if (fromApp) {
          document.addEventListener("message", receiveMessage, false);
        } else {
          window.addEventListener("message", receiveMessage, false);
        }
      }

      function receiveMessage(event) {
        try {
          var data = JSON.parse(event.data);
          if (data.event == "pausePlayer") {
            player.pause();
          } else if (data.event == "playIfPaused") {
            player.getPaused().then(function(paused) {
              if (paused) {
                player.play();
              }
            });
          } else if (data.event == "seekPlayer") {
            player.setCurrentTime(data.value);
          }
        } catch (e) {}
      }

      function toggleMute() {
        volume = volume > 0 ? 0 : 1;
        player.setVolume(volume);
        setMuteImage(volume);
      }

      function setMuteImage(v) {
        if (v > 0) {
          document.getElementById("mute_control").src =
            "./static/img/btn_villa_video_sound_on_15x15_nor.png";
        } else {
          document.getElementById("mute_control").src =
            "./static/img/btn_villa_video_sound_off_15x15_nor.png";
        }
      }
    </script>
  </body>
</html>
